<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Packs — MCP Agent Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "primary": "#059669",
            "primary-hover": "#047857",
            "accent": "#34D399",
            "background-light": "#F8FAFC",
            "surface-light": "#FFFFFF",
            "surface-subtle": "#F1F5F9",
            "border-light": "#E2E8F0",
            "text-main": "#0F172A",
            "text-subtle": "#64748B",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"],
            "mono": ["JetBrains Mono", "monospace"],
          },
        },
      },
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; vertical-align: text-bottom; }
  </style>
</head>
<body class="bg-background-light text-text-main font-display antialiased min-h-screen flex flex-col">

<!-- Header -->
<header class="sticky top-0 z-50 w-full bg-surface-light/80 backdrop-blur-xl border-b border-border-light shadow-sm">
  <div class="px-6 py-3.5 flex items-center justify-between w-full">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-surface-subtle rounded-lg transition-all lg:hidden">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <div class="size-9 rounded-xl bg-gradient-to-br from-primary to-emerald-700 flex items-center justify-center text-white shadow-lg shadow-primary/25">
        <span class="material-symbols-outlined text-[20px]">hub</span>
      </div>
      <div>
        <h1 class="text-lg font-bold tracking-tight text-text-main leading-tight">MCP Agent Dashboard</h1>
        <p class="text-[11px] font-medium text-text-subtle hidden sm:block">Num Agents v2.0</p>
      </div>
    </div>
  </div>
</header>

<!-- Sidebar + Main -->
<div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-64 bg-surface-light border-r border-border-light overflow-y-auto z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
    <nav class="p-4 space-y-2">
      <a href="/" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">dashboard</span>
        Dashboard
      </a>
      <a href="/catalog" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">list</span>
        Catalog
      </a>
      <a href="/packs" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-primary bg-primary/5 rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">inventory_2</span>
        Packs
      </a>
      <a href="/agent-detail" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">info</span>
        Agent Detail
      </a>
      <a href="/editor" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">edit</span>
        Editor
      </a>
      <a href="/playground" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">play_arrow</span>
        Playground
      </a>
      <a href="/scoring" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">grade</span>
        Scoring
      </a>
      <a href="/model-health" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">monitor_heart</span>
        Model Health
      </a>
    </nav>
  </aside>

  <!-- Overlay for mobile -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-6">

  <!-- Page Title -->
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold tracking-tight text-text-main">Packs</h2>
      <p class="text-sm font-medium text-text-subtle mt-1">Manage agent packs, validate, test, and export</p>
    </div>
    <button onclick="showInstallModal()" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover transition-all flex items-center gap-2">
      <span class="material-symbols-outlined text-[18px]">add</span>
      Install Pack
    </button>
  </div>

  <!-- Packs Grid -->
  <div id="packsGrid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm text-center text-text-subtle">
      Loading packs...
    </div>
  </div>

  <!-- Operations Panel -->
  <div class="bg-surface-light rounded-xl border border-border-light shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-border-light bg-surface-subtle">
      <h3 class="text-lg font-bold text-text-main">Pack Operations</h3>
      <p class="text-sm text-text-subtle mt-1">Validate, simulate, and test your packs</p>
    </div>
    <div class="p-6 space-y-6">
      <!-- Validate & Simulate -->
      <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-surface-subtle rounded-xl">
        <div class="flex-1">
          <div class="font-semibold text-text-main">Validate & Simulate All</div>
          <div class="text-sm text-text-subtle mt-1">Run validation and dry-run simulation on all agents in the pack</div>
        </div>
        <div class="flex gap-2">
          <select id="validatePackId" class="px-3 py-2 bg-white border border-border-light rounded-lg text-sm font-medium">
            <option value="num-pack">num-pack</option>
          </select>
          <button onclick="runValidateSimulate()" id="btnValidate" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">check_circle</span>
            Run
          </button>
        </div>
      </div>

      <!-- Smoke Tests -->
      <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-surface-subtle rounded-xl">
        <div class="flex-1">
          <div class="font-semibold text-text-main">Smoke Tests</div>
          <div class="text-sm text-text-subtle mt-1">Run smoke tests on a subset of agents</div>
        </div>
        <div class="flex gap-2 flex-wrap">
          <select id="smokePackId" class="px-3 py-2 bg-white border border-border-light rounded-lg text-sm font-medium">
            <option value="num-pack">num-pack</option>
          </select>
          <button onclick="runSmoke(10)" class="px-4 py-2 bg-yellow-500 text-white text-sm font-semibold rounded-lg hover:bg-yellow-600 transition-all">
            Smoke 10
          </button>
          <button onclick="runSmoke(50)" class="px-4 py-2 bg-yellow-500 text-white text-sm font-semibold rounded-lg hover:bg-yellow-600 transition-all">
            Smoke 50
          </button>
          <button onclick="runSmoke(0)" class="px-4 py-2 bg-yellow-600 text-white text-sm font-semibold rounded-lg hover:bg-yellow-700 transition-all">
            Smoke All
          </button>
        </div>
      </div>

      <!-- Export Bundle -->
      <div class="flex flex-col md:flex-row md:items-center gap-4 p-4 bg-surface-subtle rounded-xl">
        <div class="flex-1">
          <div class="font-semibold text-text-main">Export Bundle</div>
          <div class="text-sm text-text-subtle mt-1">Export pack as a signed bundle for marketplace distribution</div>
        </div>
        <div class="flex gap-2">
          <select id="exportPackId" class="px-3 py-2 bg-white border border-border-light rounded-lg text-sm font-medium">
            <option value="num-pack">num-pack</option>
          </select>
          <button onclick="exportBundle()" class="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">package_2</span>
            Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Panel -->
  <div class="bg-surface-light rounded-xl border border-border-light shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-border-light bg-surface-subtle flex items-center justify-between">
      <h3 class="text-lg font-bold text-text-main">Results</h3>
      <button onclick="clearResults()" class="text-sm text-text-subtle hover:text-text-main">Clear</button>
    </div>
    <div id="resultsPanel" class="p-6">
      <div class="text-text-subtle text-sm">Run an operation to see results here</div>
    </div>
  </div>

  <!-- Reports History -->
  <div class="bg-surface-light rounded-xl border border-border-light shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-border-light bg-surface-subtle flex items-center justify-between">
      <h3 class="text-lg font-bold text-text-main">Reports History</h3>
      <button onclick="loadReports()" class="text-sm text-primary hover:text-primary-hover font-medium">Refresh</button>
    </div>
    <div id="reportsPanel" class="divide-y divide-border-light">
      <div class="px-6 py-4 text-text-subtle text-sm">Loading reports...</div>
    </div>
  </div>

</main>

<!-- Install Modal -->
<div id="installModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-surface-light rounded-2xl shadow-xl max-w-lg w-full mx-4 overflow-hidden">
    <div class="px-6 py-4 border-b border-border-light bg-surface-subtle flex items-center justify-between">
      <h3 class="text-lg font-bold text-text-main">Install Pack</h3>
      <button onclick="hideInstallModal()" class="p-1 text-text-subtle hover:text-text-main rounded-lg hover:bg-white transition-all">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-text-main mb-2">Bundle URL or Path</label>
        <input id="installUrl" type="text" placeholder="https://... or ./bundles/pack.json" class="w-full px-4 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"/>
      </div>
      <div>
        <label class="block text-sm font-medium text-text-main mb-2">Or paste bundle JSON</label>
        <textarea id="installJson" rows="6" placeholder='{"id": "my-pack", ...}' class="w-full px-4 py-2 border border-border-light rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"></textarea>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="installTrust" class="rounded border-border-light text-primary focus:ring-primary/20"/>
        <label for="installTrust" class="text-sm text-text-subtle">Trust this publisher</label>
      </div>
    </div>
    <div class="px-6 py-4 border-t border-border-light bg-surface-subtle flex justify-end gap-3">
      <button onclick="hideInstallModal()" class="px-4 py-2 text-sm font-semibold text-text-subtle hover:text-text-main transition-all">Cancel</button>
      <button onclick="installPack()" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover transition-all">Install</button>
    </div>
  </div>

  </main>
</div>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  }

  async function loadPacks() {
    try {
      const r = await fetch('/api/catalog?packId=num-pack');
      const j = await r.json();
      const packs = [{ id: 'num-pack', version: '1.0.0', agents: j.ok ? (j.catalog?.count || 0) : 0, status: j.ok ? 'ok' : 'error' }];
      renderPacks(packs);
    } catch (e) {
      document.getElementById('packsGrid').innerHTML = `<div class="bg-surface-light rounded-xl border border-red-200 p-6 text-red-500">Error loading packs: ${e.message}</div>`;
    }
  }

  function renderPacks(packs) {
    document.getElementById('packsGrid').innerHTML = packs.map(p => `
      <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-3">
            <div class="size-12 rounded-xl bg-gradient-to-br from-primary to-emerald-700 flex items-center justify-center text-white">
              <span class="material-symbols-outlined text-[24px]">inventory_2</span>
            </div>
            <div>
              <div class="font-bold text-text-main">${esc(p.id)}</div>
              <div class="text-sm text-text-subtle">v${esc(p.version)}</div>
            </div>
          </div>
          <span class="px-2 py-1 text-xs font-bold rounded-full ${p.status === 'ok' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}">${p.status === 'ok' ? 'OK' : 'Error'}</span>
        </div>
        <div class="mt-4 pt-4 border-t border-border-light">
          <div class="flex items-center justify-between text-sm">
            <span class="text-text-subtle">Agents</span>
            <span class="font-bold text-text-main">${p.agents}</span>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <a href="/catalog?packId=${esc(p.id)}" class="flex-1 px-3 py-2 text-center text-sm font-medium text-primary bg-primary/5 rounded-lg hover:bg-primary/10 transition-all">View Catalog</a>
          <button onclick="selectPack('${esc(p.id)}')" class="px-3 py-2 text-sm font-medium text-text-subtle bg-surface-subtle rounded-lg hover:bg-gray-200 transition-all">
            <span class="material-symbols-outlined text-[18px]">more_vert</span>
          </button>
        </div>
      </div>
    `).join('');
  }

  function selectPack(id) {
    document.getElementById('validatePackId').value = id;
    document.getElementById('smokePackId').value = id;
    document.getElementById('exportPackId').value = id;
  }

  async function runValidateSimulate() {
    const packId = document.getElementById('validatePackId').value;
    const btn = document.getElementById('btnValidate');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined text-[18px] animate-spin">refresh</span> Running...';
    showResult('Running validate & simulate...', 'info');

    try {
      const r = await fetch('/api/packops/validate-simulate-all', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ packId })
      });
      const j = await r.json();
      if (j.ok) {
        showResult(`<div class="space-y-2">
          <div class="font-bold text-green-600">Validate & Simulate Complete</div>
          <div class="text-sm">Total: ${j.total || 0} | Valid: ${j.valid || 0} | Warnings: ${j.warnings || 0} | Errors: ${j.errors || 0}</div>
          ${j.reportPath ? `<div class="text-xs text-text-subtle">Report: ${j.reportPath}</div>` : ''}
        </div>`, 'success');
      } else {
        showResult(`Error: ${j.error || 'Unknown error'}`, 'error');
      }
    } catch (e) {
      showResult(`Error: ${e.message}`, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined text-[18px]">check_circle</span> Run';
  }

  async function runSmoke(limit) {
    const packId = document.getElementById('smokePackId').value;
    showResult(`Running smoke test (${limit || 'all'} agents)...`, 'info');

    try {
      const r = await fetch('/api/smoke/start', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ packId, limit: limit || undefined, dryRun: true })
      });
      const j = await r.json();
      if (j.ok) {
        showResult(`<div class="space-y-2">
          <div class="font-bold text-green-600">Smoke Test Complete</div>
          <div class="text-sm">Ran: ${j.ran || 0} | Passed: ${j.passed || 0} | Failed: ${j.failed || 0}</div>
          <div class="text-sm">Duration: ${j.durationMs ? (j.durationMs / 1000).toFixed(1) + 's' : '—'}</div>
        </div>`, 'success');
      } else {
        showResult(`Error: ${j.error || 'Unknown error'}`, 'error');
      }
    } catch (e) {
      showResult(`Error: ${e.message}`, 'error');
    }
  }

  async function exportBundle() {
    const packId = document.getElementById('exportPackId').value;
    showResult('Exporting bundle...', 'info');

    try {
      const r = await fetch('/api/model-health/git-ops', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ packId, packDir: `./packs/${packId}`, createBundle: true })
      });
      const j = await r.json();
      if (j.ok && j.result) {
        showResult(`<div class="space-y-2">
          <div class="font-bold text-green-600">Bundle Exported</div>
          <div class="text-sm font-mono">${j.result.bundlePath || 'Bundle created'}</div>
        </div>`, 'success');
      } else {
        showResult(`Error: ${j.error || j.result?.error || 'Unknown error'}`, 'error');
      }
    } catch (e) {
      showResult(`Error: ${e.message}`, 'error');
    }
  }

  function showResult(html, type) {
    const colors = { info: 'bg-blue-50 border-blue-200 text-blue-800', success: 'bg-green-50 border-green-200 text-green-800', error: 'bg-red-50 border-red-200 text-red-800' };
    document.getElementById('resultsPanel').innerHTML = `<div class="p-4 rounded-xl border ${colors[type] || colors.info}">${html}</div>`;
  }

  function clearResults() {
    document.getElementById('resultsPanel').innerHTML = '<div class="text-text-subtle text-sm">Run an operation to see results here</div>';
  }

  async function loadReports() {
    try {
      const [packops, smoke, batch] = await Promise.all([
        fetch('/api/reports').then(r => r.json()).catch(() => ({ reports: [] })),
        fetch('/api/reports/model-health-batch').then(r => r.json()).catch(() => ({ reports: [] })),
        fetch('/api/reports/model-health').then(r => r.json()).catch(() => ({ reports: [] }))
      ]);

      const all = [
        ...(packops.reports || []).map(r => ({ ...r, type: 'packops' })),
        ...(smoke.reports || []).map(r => ({ ...r, type: 'batch' })),
        ...(batch.reports || []).map(r => ({ ...r, type: 'health' }))
      ].slice(0, 10);

      if (!all.length) {
        document.getElementById('reportsPanel').innerHTML = '<div class="px-6 py-4 text-text-subtle text-sm">No reports yet</div>';
        return;
      }

      document.getElementById('reportsPanel').innerHTML = all.map(r => `
        <div class="px-6 py-3 flex items-center justify-between hover:bg-surface-subtle transition-colors">
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-text-subtle">${r.type === 'packops' ? 'check_circle' : r.type === 'batch' ? 'layers' : 'monitor_heart'}</span>
            <div>
              <div class="text-sm font-medium text-text-main">${esc(r.id || r.path?.split('/').pop() || 'Report')}</div>
              <div class="text-xs text-text-subtle">${r.type}</div>
            </div>
          </div>
          <a href="${r.path ? `/api/reports/${r.id}` : '#'}" target="_blank" class="text-sm text-primary hover:text-primary-hover font-medium">View</a>
        </div>
      `).join('');
    } catch (e) {
      document.getElementById('reportsPanel').innerHTML = `<div class="px-6 py-4 text-red-500 text-sm">Error: ${e.message}</div>`;
    }
  }

  function showInstallModal() {
    document.getElementById('installModal').classList.remove('hidden');
    document.getElementById('installModal').classList.add('flex');
  }

  function hideInstallModal() {
    document.getElementById('installModal').classList.add('hidden');
    document.getElementById('installModal').classList.remove('flex');
  }

  async function installPack() {
    const url = document.getElementById('installUrl').value.trim();
    const json = document.getElementById('installJson').value.trim();
    const trust = document.getElementById('installTrust').checked;

    if (!url && !json) {
      alert('Please provide a URL or paste bundle JSON');
      return;
    }

    try {
      const r = await fetch('/api/marketplace/install', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ url: url || undefined, bundle: json ? JSON.parse(json) : undefined, trust })
      });
      const j = await r.json();
      if (j.ok) {
        alert('Pack installed successfully!');
        hideInstallModal();
        loadPacks();
      } else {
        alert('Install failed: ' + (j.error || 'Unknown error'));
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  function esc(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  loadPacks();
  loadReports();
</script>

</body>
</html>
