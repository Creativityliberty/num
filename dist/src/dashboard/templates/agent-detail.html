<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Agent Detail — MCP Agent Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "primary": "#059669",
            "primary-hover": "#047857",
            "accent": "#34D399",
            "background-light": "#F8FAFC",
            "surface-light": "#FFFFFF",
            "surface-subtle": "#F1F5F9",
            "border-light": "#E2E8F0",
            "text-main": "#0F172A",
            "text-subtle": "#64748B",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"],
            "mono": ["JetBrains Mono", "monospace"],
          },
        },
      },
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; vertical-align: text-bottom; }
  </style>
</head>
<body class="bg-background-light text-text-main font-display antialiased min-h-screen flex flex-col">

<!-- Header -->
<header class="sticky top-0 z-50 w-full bg-surface-light/80 backdrop-blur-xl border-b border-border-light shadow-sm">
  <div class="px-6 py-3.5 flex items-center justify-between w-full">
    <div class="flex items-center gap-4">
      <a href="/catalog" class="p-2 hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined">arrow_back</span>
      </a>
      <div class="size-9 rounded-xl bg-gradient-to-br from-primary to-emerald-700 flex items-center justify-center text-white shadow-lg shadow-primary/25">
        <span class="material-symbols-outlined text-[20px]">hub</span>
      </div>
      <div>
        <h1 class="text-lg font-bold tracking-tight text-text-main leading-tight">Agent Detail</h1>
        <p class="text-[11px] font-medium text-text-subtle hidden sm:block" id="agentId">Loading...</p>
      </div>
    </div>
  </div>
</header>

<!-- Sidebar + Main -->
<div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-64 bg-surface-light border-r border-border-light overflow-y-auto z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
    <nav class="p-4 space-y-2">
      <a href="/" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">dashboard</span>
        Dashboard
      </a>
      <a href="/catalog" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">list</span>
        Catalog
      </a>
      <a href="/packs" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">inventory_2</span>
        Packs
      </a>
      <a href="/agent-detail" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-primary bg-primary/5 rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">info</span>
        Agent Detail
      </a>
      <a href="/editor" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">edit</span>
        Editor
      </a>
      <a href="/playground" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">play_arrow</span>
        Playground
      </a>
      <a href="/scoring" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">grade</span>
        Scoring
      </a>
      <a href="/model-health" class="flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-subtle hover:text-text-main hover:bg-surface-subtle rounded-lg transition-all">
        <span class="material-symbols-outlined text-[20px]">monitor_heart</span>
        Model Health
      </a>
    </nav>
  </aside>

  <!-- Overlay for mobile -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-6">

    <!-- Agent Header -->
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm">
      <div class="flex items-start justify-between">
        <div>
          <h2 id="agentName" class="text-2xl font-bold text-text-main">Agent Name</h2>
          <div class="flex items-center gap-3 mt-2">
            <span id="statusBadge" class="px-3 py-1 text-xs font-bold bg-green-50 text-green-600 rounded-full">Valid</span>
            <span id="chefBadge" class="px-3 py-1 text-xs font-bold bg-blue-50 text-blue-600 rounded-full hidden">Chef</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="simulateAgent()" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">play_arrow</span>
            Simulate
          </button>
          <button onclick="editAgent()" class="px-4 py-2 bg-primary text-white text-sm font-semibold rounded-lg hover:bg-primary-hover transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-[18px]">edit</span>
            Edit
          </button>
        </div>
      </div>
      <div id="tagsContainer" class="flex flex-wrap gap-2 mt-4"></div>
    </div>

    <!-- Flow Graph -->
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm">
      <h3 class="text-lg font-bold text-text-main mb-4">Flow Graph</h3>
      <div id="flowGraph" class="bg-surface-subtle rounded-lg p-8 text-center text-text-subtle">
        <span class="material-symbols-outlined text-4xl mb-2 opacity-30">hub</span>
        <p class="font-medium">Flow visualization loading...</p>
      </div>
    </div>

    <!-- Runtime Policy -->
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm">
      <h3 class="text-lg font-bold text-text-main mb-4">Runtime Policy</h3>
      <div id="policyContent" class="space-y-4">
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-sm font-medium text-text-subtle">Preferred Model</div>
          <div id="preferredModel" class="text-text-main font-mono text-sm mt-2">—</div>
        </div>
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-sm font-medium text-text-subtle">Fallbacks</div>
          <div id="fallbacks" class="text-text-main font-mono text-sm mt-2">—</div>
        </div>
      </div>
    </div>

    <!-- Last Runs -->
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm">
      <h3 class="text-lg font-bold text-text-main mb-4">Last Runs</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-surface-subtle border-b border-border-light">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-bold text-text-subtle uppercase tracking-wider">Run ID</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-text-subtle uppercase tracking-wider">Status</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-text-subtle uppercase tracking-wider">Duration</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-text-subtle uppercase tracking-wider">Model</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-text-subtle uppercase tracking-wider">Date</th>
            </tr>
          </thead>
          <tbody id="runsTable" class="divide-y divide-border-light">
            <tr><td colspan="5" class="px-4 py-8 text-center text-text-subtle">Loading runs...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Health Metrics -->
    <div class="bg-surface-light rounded-xl border border-border-light p-6 shadow-sm">
      <h3 class="text-lg font-bold text-text-main mb-4">Health Metrics</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-xs font-bold text-text-subtle uppercase tracking-wider">Success Rate</div>
          <div id="successRate" class="text-2xl font-bold text-primary mt-2">—</div>
        </div>
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-xs font-bold text-text-subtle uppercase tracking-wider">Avg Duration</div>
          <div id="avgDuration" class="text-2xl font-bold text-text-main mt-2">—</div>
        </div>
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-xs font-bold text-text-subtle uppercase tracking-wider">Model Usage</div>
          <div id="modelUsage" class="text-2xl font-bold text-text-main mt-2">—</div>
        </div>
        <div class="p-4 bg-surface-subtle rounded-lg">
          <div class="text-xs font-bold text-text-subtle uppercase tracking-wider">Cost/Run</div>
          <div id="costPerRun" class="text-2xl font-bold text-text-main mt-2">—</div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('-translate-x-full');
    overlay.classList.toggle('hidden');
  }

  const modeId = new URLSearchParams(window.location.search).get('id') || '';

  async function loadAgentDetail() {
    try {
      if (!modeId) {
        document.querySelector('main').innerHTML = '<div class="p-8 text-center"><p class="text-text-subtle text-lg">Select an agent from the Catalog to view details</p></div>';
        return;
      }
      const r = await fetch(`/api/agent/${encodeURIComponent(modeId)}`);
      const j = await r.json();
      if (!j.ok || !j.agent) {
        document.querySelector('main').innerHTML = '<div class="p-8 text-center"><p class="text-red-500 text-lg">Agent not found</p></div>';
        return;
      }
      const agent = j.agent;
      document.getElementById('agentId').textContent = agent.id;
      document.getElementById('agentName').textContent = agent.name || agent.id;

      // Tags
      const tagsHtml = (agent.tags || []).map(t => `<span class="px-2 py-1 text-xs font-medium bg-surface-subtle text-text-subtle rounded-full">${escapeHtml(t)}</span>`).join('');
      document.getElementById('tagsContainer').innerHTML = tagsHtml;

      // Policy
      const policy = agent.runtimePolicy || {};
      const preferred = policy.preferred || {};
      document.getElementById('preferredModel').textContent = `${preferred.provider || '—'} / ${preferred.model || '—'}`;
      const fallbacks = (policy.fallbacks || []).map(f => `${f.provider}/${f.model}`).join(', ') || '—';
      document.getElementById('fallbacks').textContent = fallbacks;

      // Health
      const health = agent.healthMetrics || {};
      document.getElementById('successRate').textContent = health.successRate ? `${Math.round(health.successRate * 100)}%` : '—';
      document.getElementById('avgDuration').textContent = health.avgDuration ? `${health.avgDuration}ms` : '—';
      document.getElementById('modelUsage').textContent = health.modelUsage ? `${Math.round(health.modelUsage.preferred * 100)}%` : '—';
      document.getElementById('costPerRun').textContent = health.costPerRun ? `$${health.costPerRun.toFixed(2)}` : '—';

      // Runs
      const runsR = await fetch(`/api/agent/${encodeURIComponent(modeId)}/runs?limit=5`);
      const runsJ = await runsR.json();
      const runs = runsJ.runs || [];
      const runsHtml = runs.length ? runs.map(r => `
        <tr class="hover:bg-surface-subtle/50 transition-colors">
          <td class="px-4 py-3 text-sm font-mono">${escapeHtml(r.id)}</td>
          <td class="px-4 py-3 text-sm"><span class="px-2 py-1 text-xs font-bold bg-green-50 text-green-600 rounded">${escapeHtml(r.status)}</span></td>
          <td class="px-4 py-3 text-sm">${r.duration}ms</td>
          <td class="px-4 py-3 text-sm">${escapeHtml(r.modelUsed)}</td>
          <td class="px-4 py-3 text-sm text-text-subtle">${new Date(r.date).toLocaleDateString()}</td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="px-4 py-8 text-center text-text-subtle">No runs yet</td></tr>';
      document.getElementById('runsTable').innerHTML = runsHtml;
    } catch (e) {
      document.body.innerHTML = `<div class="p-8 text-red-500">Error: ${e.message}</div>`;
    }
  }

  function escapeHtml(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function simulateAgent() {
    alert(`Simulate agent: ${modeId}\n(Coming soon)`);
  }

  function editAgent() {
    window.location.href = `/editor?modeId=${encodeURIComponent(modeId)}`;
  }

  loadAgentDetail();
</script>

</body>
</html>
